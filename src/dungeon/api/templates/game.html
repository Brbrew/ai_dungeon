{% extends "base.html" %}

{% block title %}Dungeon Game - Command Interface{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/game.css">
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        height: 80%;
        position: relative;
    }

    .close-modal {
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 24px;
        cursor: pointer;
    }

    #mapFrame {
        width: 100%;
        height: 100%;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="game_area_grid">
    <div class="game_area_left">Left</div>
    <div class="game_area_room">
        <img src="{{ room_img }}" id="roomImage">
    </div>
    <div class="game_area_npc">NPC</div>
    <div class="game_area_message">Message</div>
    <div class="game_area_overlay"><img src="/static/img/interface/room_overlay.webp"></div>
    <div class="game_area_console">
             <div class="output-area" id="outputArea">Welcome to the Dungeon!<br>Type 'help' for a list of available commands.<br><br></div>
                <div class="command-area">
                    <input type="text" id="commandInput" class="command-input" placeholder="Enter your command...">
                    <button id="submitCommand" class="command-button">Send</button>
                    <button id="showMap" class="command-button">Map</button>
                </div>
    </div>
    <div class="game_area_footer">Footer</div>
    <div class="game_area_right">Right</div>
</div>

<!-- Map Modal -->
<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <iframe id="mapFrame" src="/show_map"></iframe>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        console.log("Document ready, initializing game...");
        console.log("Initial room image:", "{{ room_img }}");
        
        // Game state
        let initialized = 0;
        
        // Function to initialize the game
        function init_game() {
            console.log("Initializing game...");
            if (initialized === 0) {
                initialized = 1;
                //appendOutput("Game initialized. Type 'help' for available commands.<br>", "system");
                appendOutput("{{ dungeon.scenario.description if dungeon.scenario else 'Welcome to the dungeon!' }}<br>", "system");
                parser("look");
            }
        }
        
        // Function to append text to the output area
        function appendOutput(text, type = "system") {
            let className = "command-output";
            if (type === "error") {
                className = "error-message";
            } else if (type === "system") {
                className = "help-text";
            }
            
            $('#outputArea').append(`<span class="${className}">${text}</span>\n`);
            
            // Scroll to bottom
            $('#outputArea').scrollTop($('#outputArea')[0].scrollHeight);
        }
        
        // parser function
        function parser(command) {
            console.log("Parsing command:", command);
            // Send command to the parser endpoint
            $.ajax({
                url: '/parser/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    command: command
                }),
                success: function(response) {
                    console.log("Parser response:", response);
                    appendOutput(response.message, "system");
                    
                    // Update room image if available in response
                    if (response.room_img) {
                        console.log("Updating room image to:", response.room_img);
                        $('#roomImage').attr('src', response.room_img);
                    }
                },
                error: function(error) {
                    console.error("Error parsing command:", error);
                    appendOutput(`Error: ${error.responseJSON?.detail || 'Failed to parse command'}`, "error");
                }
            });
        }

        // Function to send a command to the parser
        function sendCommand(command) {
            console.log("Sending command:", command);
            
            // Display command in output area
            $('#outputArea').append(`\n<span class="command-history">> ${command}</span>\n`);
            
            // Call parser function 
            parser(command);
            
            // Scroll to bottom
            $('#outputArea').scrollTop($('#outputArea')[0].scrollHeight);
        }
        
        // Handle command submission
        function submitCommand() {
            const command = $('#commandInput').val().trim();
            if (command) {
                sendCommand(command);
                // Clear input
                $('#commandInput').val('');
            }
        }
        
        // Handle command submission on button click
        $('#submitCommand').on('click', function() {
            console.log("Submit button clicked");
            submitCommand();
        });
        
        // Handle command submission on Enter key
        $('#commandInput').on('keypress', function(e) {
            if (e.which === 13) {  // Enter key
                console.log("Enter key pressed");
                submitCommand();
            }
        });

        // Map Modal functionality
        $('#showMap').on('click', function() {
            $('#mapModal').show();
        });

        $('.close-modal').on('click', function() {
            $('#mapModal').hide();
        });

        $(window).on('click', function(e) {
            if ($(e.target).is('#mapModal')) {
                $('#mapModal').hide();
            }
        });

        // Send initial INIT command when page loads
        init_game();
        //sendCommand("init");
    });
</script>
{% endblock %} 